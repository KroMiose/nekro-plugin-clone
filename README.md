# 人设克隆插件 (Preset Clone)

> 通过分析用户的历史聊天记录，自动生成该用户的人设配置。让 AI 学会模仿任何人的说话风格！

## 主要功能

- **智能克隆**: 只需一条命令，AI 就能分析目标用户的聊天记录，自动生成包含性格、语言风格、兴趣爱好的完整人设。
- **深度分析**: AI 会从历史消息中提取语言习惯、性格特点、常用词汇、互动方式等特征。
- **即用即存**: 生成的人设会自动保存到本地人设库，可以直接在 Web 管理页面查看、编辑和使用。

## 使用方法

### 基础用法

在群聊中使用命令：

```
/preset-clone <目标用户 QQ 号>
```

AI 会自动开始克隆过程，完成后会显示生成的人设信息。

### 使用场景

- **模仿朋友**: 克隆群友的说话风格，让 AI 学会用他们的方式回复
- **角色扮演**: 为特定角色创建人设，用于群内互动
- **风格学习**: 分析优秀内容创作者的语言特点

## 前置条件

- 目标用户至少需要有 **50 条**历史消息（可在配置中调整）
- 仅支持在**群聊**中使用
- 头像获取功能仅支持 QQ 群（OneBot v11 协议）

> 💡 **提示**: 消息数量越多、内容越丰富，生成的人设质量越好！

## 配置说明

在 Web 管理页面的插件配置中，可以调整以下选项：

### 最小消息数量
- **默认**: 50 条
- **说明**: 克隆用户至少需要的历史消息数量
- **建议**: 如果想要更高质量的人设，可以提高到 100-200 条

### 最大采样消息数
- **默认**: 200 条
- **说明**: 从历史消息中采样的最大数量
- **作用**: 用于获取更长时间跨度的消息样本

### 最大分析消息数
- **默认**: 100 条
- **说明**: 实际用于分析的消息数量
- **机制**: 从采样的消息中随机抽取，既能控制 Token 消耗，又能覆盖更长的时间周期

### 单条消息最大长度
- **默认**: 200 字符
- **说明**: 分析时单条消息的最大字符数
- **处理**: 超出部分会被截断并加上"..."

### 总内容最大长度
- **默认**: 10000 字符
- **说明**: 所有消息拼接后的最大总长度
- **作用**: 避免超出模型上下文限制，确保分析稳定性

### 前置/后置上下文消息数
- **默认**: 各 3 条
- **说明**: 收集目标用户每条消息前后的上下文消息数量
- **作用**: 帮助 AI 理解完整的对话场景，避免断章取义
- **范围**: 0-10 条（建议保持默认值）

### 忽略会话重置时间
- **默认**: 关闭（False）
- **说明**: 是否忽略会话重置时间限制
- **效果**: 
  - 关闭：仅收集当前会话的消息（推荐）
  - 开启：收集所有历史消息，不受 AI 会话重置时间影响
- **使用场景**: 分析其他用户的人设时，可能需要开启此选项以获取更完整的历史数据

### 分批加载大小
- **默认**: 500 条/批次
- **说明**: 每次从数据库读取的消息批次大小
- **作用**: 避免一次性加载过多数据造成数据库压力
- **机制**: 先读取最近的一批，不足时再往前读取更多批次

### 克隆分析模型组
- **默认**: default-chat
- **说明**: 用于分析和生成人设的 AI 模型
- **重要**: 强烈建议使用智能程度较高的模型（如 GPT-4o、Claude-3.5-Sonnet 等）

### 分析超时时间
- **默认**: 120 秒
- **说明**: 人设分析的最长等待时间

### 自动添加标签
- **默认**: "克隆"
- **说明**: 克隆生成的人设会自动添加这个标签，方便管理

## 生成结果

克隆完成后会生成包含以下内容的完整人设：

- ✨ **人设名称**: 简洁干净的名称，例如"小明"
- 📝 **人设描述**: 一句话概括用户的核心特征
- 📖 **详细内容**: 300-800字的深度分析，包括：
  - 性格特征（开朗、幽默、严谨等）
  - 语言风格（口语化、文雅、网络用语等）
  - 兴趣爱好（经常讨论的话题）
  - 行为特征（互动方式、回复习惯）
  - 个性化特征（口头禅、标志性表达）
- 🏷️ **标签**: 自动分类标签
- 🖼️ **头像**: 用户的 QQ 头像

## 实际示例

假设要克隆一个经常在群里分享技术内容的用户：

```
/preset-clone 123456789
```

**AI 的处理过程**：

1. 📊 分批收集该用户的历史消息（每批 500 条，直到达到采样目标 200 条）
2. 🔍 同时收集每条消息的前后上下文（各 1 条），理解完整对话场景
3. 🎲 从样本中随机抽取 100 条进行分析（保证时间顺序，覆盖更长周期）
4. ✂️ 压缩每条消息长度，控制总内容在合理范围
5. 🤔 AI 分析：发现用户经常使用专业术语、喜欢分享技术文章、回复详细且逻辑清晰
6. ✍️ 生成人设：创建一个"技术达人"风格的人设
7. 💾 保存到本地人设库

**生成的人设可能包含**：

> 我是一个热爱技术的程序员，喜欢深入研究各种技术栈。在聊天时我会用比较专业的术语，偶尔会分享一些有趣的技术文章链接。我回复问题时会比较详细，喜欢把原理解释清楚...

## 注意事项

⚠️ **重要提示**：

1. **数据质量**: 目标用户的消息内容越丰富多样，生成的人设质量越高
2. **隐私考虑**: 克隆功能会分析用户的历史发言，请注意隐私保护和征求被克隆用户的同意
3. **成本考虑**: AI 分析会消耗 Token，使用高质量模型成本较高
4. **后期优化**: 建议在 Web 管理页面对生成的人设进行人工微调
5. **仅限文本**: 插件只分析文字消息，图片、文件等内容会被忽略

## 常见问题

### Q: 为什么提示"消息数量不足"？

**A**: 目标用户的历史消息少于配置的最小数量（默认 50 条）。解决方法：

- 等待用户发送更多消息后再尝试
- 在插件配置中降低"最小消息数量"（不建议低于 30）
- 如果开启了"忽略会话重置时间"，可能是用户在整个历史中的消息都不足

### Q: 生成的人设不够准确怎么办？

**A**: 可以尝试：

- 使用更智能的 AI 模型（在"克隆分析模型组"中配置）
- 确保目标用户有足够多样的聊天内容
- 在 Web 管理页面手动编辑优化人设内容

### Q: 克隆后的人设在哪里？

**A**: 生成的人设会自动保存到本地人设库。前往 Web 管理页面的 `人设管理` 页面，可以看到所有人设，克隆的人设通常会带有"克隆"标签。

## 进阶技巧

### 1. 选择合适的克隆对象

✅ **推荐克隆**：
- 在群内活跃、消息多样的用户
- 有明显语言风格的用户
- 经常分享特定话题的用户

❌ **不建议克隆**：
- 消息数量很少的用户
- 只发表情包、图片的用户
- 发言内容过于简短单一的用户

### 2. 模型选择建议

不同场景推荐的模型：

- **追求质量**: GPT-4o、Claude-3.5-Sonnet（成本较高，效果最好）
- **平衡性价比**: GPT-4o-mini、Claude-3-Haiku（成本适中，效果良好）
- **低成本**: 本地模型或开源模型（成本低，效果依赖模型质量）

### 3. 后期优化流程

1. 克隆完成后，记下人设 ID
2. 前往 Web 管理页面的人设管理
3. 找到对应人设并点击编辑
4. 优化以下内容：
   - 删除不准确的描述
   - 补充遗漏的特征
   - 调整语言表达
   - 完善标签分类

### 4. 标签管理

合理使用标签可以更好地组织人设：

- 添加角色类型标签：技术、娱乐、学习等
- 添加风格标签：幽默、严肃、温柔等
- 添加来源标签：群友、网红、虚拟角色等

## 更新日志

### v1.0.0 (2024)

- ✨ 首次发布
- 🎯 支持通过 QQ 号和 @提及克隆用户
- 🧠 智能分析 5 个维度的用户特征
- 💾 自动保存到本地人设库
- 🖼️ 支持 QQ 头像获取和压缩
- ⚙️ 提供丰富的配置选项

## 技术支持

- **问题反馈**: [GitHub Issues](https://github.com/KroMiose/nekro-agent/issues)
- **交流群**: 636925153
- **官方文档**: [Nekro-Agent 文档](https://doc.nekro.ai/)

## 开源协议

MIT License

---

<div align="center">
  <sub>让 AI 学会每个人独特的说话方式 🎭</sub>
</div>
