# 人设克隆插件使用指南

## 功能说明

人设克隆插件可以通过分析用户的历史聊天记录，自动生成该用户的人设配置，包括语言风格、性格特征、兴趣爱好等。

## 使用命令

```
/preset-clone <用户QQ号>
或
/preset-clone @用户
```

## 使用流程

1. **触发克隆**: 在群聊中使用命令指定要克隆的目标用户
2. **数据收集**: 插件自动收集该用户的历史消息、头像、昵称
3. **AI 分析**: 使用配置的模型组分析用户特征
4. **保存人设**: 生成的人设自动保存到本地人设库

## 前置条件

- 目标用户至少需要有 **50 条** 历史消息（可在配置中调整）
- 仅支持在群聊中使用
- 头像获取功能仅支持 OneBot v11 适配器（QQ 协议）

## 配置说明

### 最小消息数量 (MIN_MESSAGE_COUNT)

- 默认值: 50
- 说明: 克隆用户至少需要的历史消息数量
- 建议: 消息数量越多，分析越准确

### 最大采样消息数 (MAX_MESSAGE_SAMPLE)

- 默认值: 200
- 说明: 从历史消息中采样的最大数量
- 作用: 用于获取更长时间跨度的消息样本

### 最大分析消息数 (MAX_MESSAGE_ANALYZE)

- 默认值: 100
- 说明: 实际用于分析的消息数量，从采样中随机抽取
- 机制: 保持时间顺序的同时覆盖更长时间周期
- 建议: 根据模型性能和成本调整，建议在 50-150 之间

### 单条消息最大长度 (MAX_MESSAGE_LENGTH)

- 默认值: 200 字符
- 说明: 分析时单条消息的最大字符数
- 处理: 超出部分会被截断并加上"..."
- 建议: 保持在 100-300 之间，避免过长消息影响分析

### 总内容最大长度 (MAX_TOTAL_CONTENT_LENGTH)

- 默认值: 10000 字符
- 说明: 所有消息拼接后的最大总长度
- 作用: 确保不超出模型上下文限制
- 建议: 根据模型上下文窗口调整

### 前置上下文消息数 (CONTEXT_BEFORE)

- 默认值: 3
- 说明: 收集目标用户每条消息前的上下文消息数量
- 作用: 帮助 AI 理解完整的对话场景，避免断章取义
- 范围: 0-10 条
- 建议: 保持默认值 3，增加会提升分析质量但也会增加 Token 消耗

### 后置上下文消息数 (CONTEXT_AFTER)

- 默认值: 3
- 说明: 收集目标用户每条消息后的上下文消息数量
- 作用: 理解目标用户的发言引发的反应和互动效果
- 范围: 0-10 条
- 建议: 保持默认值 3

### 忽略会话重置时间 (IGNORE_SESSION_RESET)

- 默认值: False（关闭）
- 说明: 是否忽略 AI 会话重置时间的限制
- 效果:
  - 关闭（默认）: 仅收集当前会话（会话重置时间之后）的消息
  - 开启: 收集所有历史消息，不受会话重置时间影响
- 使用场景: 
  - 分析其他用户的人设时，用户的发言不受 AI 会话重置影响，可以开启此选项获取更完整的历史数据
  - 如果需要基于用户长期表现生成人设，建议开启
- 注意: 开启后可能会收集大量历史数据，需配合分批加载机制

### 分批加载大小 (BATCH_LOAD_SIZE)

- 默认值: 500 条/批次
- 说明: 每次从数据库读取的消息批次大小
- 作用: 避免一次性加载所有历史数据造成数据库压力
- 机制:
  - 先加载最近的一批消息
  - 如果目标用户消息数量不足，再往前加载更多批次
  - 最多迭代 10 次，避免无限循环
- 范围: 100-2000 条
- 建议: 
  - 默认 500 条适用于大多数场景
  - 如果用户发言频繁，可以适当增加批次大小减少数据库查询次数
  - 如果数据库性能较弱，可以适当减小批次大小

### 克隆分析模型组 (USE_CLONE_MODEL_GROUP)

- 默认值: default-chat
- 说明: 用于分析和生成人设的模型组
- **重要**: 建议使用智能程度较高的模型（如 GPT-4、Claude-3.5 等）以获得更好的人设质量

### 分析超时时间 (TIMEOUT)

- 默认值: 120 秒
- 说明: 人设分析的超时时间
- 建议: 根据模型响应速度调整

### 自动添加标签 (AUTO_ADD_TAG)

- 默认值: "克隆"
- 说明: 克隆生成的人设自动添加的标签
- 用途: 方便在人设库中筛选和管理克隆人设

## 生成结果

生成的人设包含以下内容：

- **人设名称**: 基于用户昵称生成（如：小明）- 简洁干净，不带前缀
- **人设标题**: 简短的人设标识（如：小明的克隆体）- 用于展示
- **人设描述**: 一句话概括核心特征（50-100 字）
- **人设内容**: 详细的人设描述（300-800 字），包含：
  - 性格特征
  - 语言风格
  - 兴趣爱好
  - 行为特征
  - 个性化特征
- **标签**: 相关标签，便于分类管理
- **头像**: 用户的 QQ 头像（压缩后的 base64 格式）

## 使用示例

### 基础使用

```
/preset-clone 123456789
```

插件会分析 QQ 号为 123456789 的用户历史消息并生成人设。

### 使用@提及

```
/preset-clone @小明
```

插件会提取被@用户的 QQ 号并进行克隆。

### 查看结果

克隆完成后，命令会返回人设的基本信息，包括人设 ID。

前往 Web 管理页面（`系统配置` -> `人设管理`）可以查看、编辑和使用生成的人设。

## 注意事项

1. **数据质量**: 目标用户的消息内容越丰富多样，生成的人设质量越高
2. **隐私考虑**: 此功能会分析用户的历史发言，请注意隐私保护
3. **成本考虑**: AI 分析会消耗 Token，使用高智能模型成本较高
4. **结果调整**: 生成的人设可能需要人工微调，建议生成后在 Web 页面编辑优化
5. **消息内容**: 只会分析文本消息，图片、文件等多媒体内容会被忽略

## 常见问题

### Q: 为什么提示消息数量不足？

A: 目标用户的历史消息少于配置的最小消息数量（默认 50 条）。可以：

- 等待用户发送更多消息
- 在配置中降低 `MIN_MESSAGE_COUNT`（不建议低于 30）
- 如果开启了 `IGNORE_SESSION_RESET`，可能是用户在整个历史中的消息都不足

### Q: 如何提高人设生成质量？

A:

- 使用智能程度更高的模型（配置 `USE_CLONE_MODEL_GROUP`）
- 确保目标用户有足够多样的聊天内容
- 生成后在 Web 页面手动优化人设内容

### Q: 克隆的人设可以直接使用吗？

A: 可以，但建议先在 Web 页面查看并适当调整：

- 检查人设内容是否准确
- 调整过于具体或不合适的描述
- 优化语言表达

### Q: 为什么没有头像？

A: 头像获取功能仅支持 OneBot v11 适配器（QQ 协议）。如果获取失败，会使用默认头像。

### Q: 可以克隆 Bot 自己吗？

A: 理论上可以，但 Bot 的消息通常格式统一，克隆效果可能不理想。

## 技术细节

### 分析过程

1. **消息采集**: 
   - 使用分批加载策略从数据库查询目标用户的历史消息
   - 每批加载 BATCH_LOAD_SIZE（默认 500）条消息
   - 如果数量不足，继续往前加载更多批次（最多 10 次）
   - 根据 IGNORE_SESSION_RESET 配置决定是否限制时间范围
2. **上下文收集**:
   - 为每条目标用户消息收集前后上下文（CONTEXT_BEFORE/CONTEXT_AFTER）
   - 自动去重，避免重复收集相同消息
   - 按时间排序，保持对话连贯性
3. **采样优化**:
   - 如果消息数量超过 MAX_MESSAGE_ANALYZE，进行随机采样
   - 采样时保持时间顺序，确保覆盖更长时间跨度
   - 避免只分析最近的消息，获得更全面的用户画像
4. **消息压缩**:
   - 限制单条消息长度（默认 200 字符）
   - 控制总内容长度（默认 10000 字符）
   - 超出部分截断，避免 Token 超限
5. **消息过滤**: 只提取包含文本内容的消息
6. **格式化**: 
   - 标注目标用户消息（【目标】前缀）
   - 包含时间戳（仅在时间跨度 > 1 小时时显示，节省 Token）
   - 格式：`[时间] 【目标】昵称: 内容` 或 `昵称: 内容`
7. **AI 分析**: 使用专门设计的提示词引导 AI 进行深度分析
8. **结果解析**: 解析 AI 返回的 JSON 格式人设数据
9. **数据保存**: 将人设保存到数据库，包含压缩后的头像

### 提示词设计

插件使用了精心设计的提示词模板，引导 AI 从以下维度分析用户：

- 性格特征分析
- 语言风格提取
- 兴趣爱好识别
- 行为模式总结
- 个性化特征捕捉

### 数据处理

- **分批加载策略**:
  - 使用 offset + limit 分批查询，避免一次性加载所有数据
  - 每批加载 BATCH_LOAD_SIZE（默认 500）条消息
  - 达到目标数量或没有更多消息时停止
  - 最多迭代 10 次，防止无限循环
- **上下文增强**:
  - 为每条目标消息收集前后上下文（默认各 1 条）
  - 使用 dict 自动去重，避免重复添加相同消息
  - 帮助 AI 理解完整对话场景，避免断章取义
- **消息采样**:
  - 第一步：采样最多 MAX_MESSAGE_SAMPLE（默认 200）条消息作为样本池
  - 第二步：从样本中随机抽取 MAX_MESSAGE_ANALYZE（默认 100）条用于分析
  - 优势：既控制 Token 消耗，又能覆盖更长的时间周期
- **内容压缩**:
  - 单条消息限制 MAX_MESSAGE_LENGTH（默认 200）字符，超出截断
  - 总内容限制 MAX_TOTAL_CONTENT_LENGTH（默认 10000）字符
  - 智能截断，保留关键信息
  - 时间戳优化：仅在时间跨度 > 1 小时时显示，节省 Token
- **头像压缩**: 头像压缩到 256x256，JPEG 格式，质量 85%
- **时间统计**: 自动计算消息的时间跨度
- **错误处理**: 
  - 完善的异常处理和用户提示
  - 正确处理 NoneBot 控制流异常（FinishedException 等）

## 最佳实践

1. **选择合适的目标**: 选择在群内活跃、消息多样的用户进行克隆
2. **配置推荐模型**: 使用 GPT-4o、Claude-3.5-Sonnet 等高质量模型
3. **调整采样参数**:
   - 对于发言很多的用户，可以增加采样数量获取更长时间跨度
   - 对于成本敏感的场景，可以减少分析消息数
4. **后期优化**: 生成后在 Web 页面完善人设细节
5. **标签管理**: 合理使用标签，便于人设分类和检索
6. **定期更新**: 随着用户发言积累，可以重新克隆以获得更新的人设

## 扩展建议

如果需要更多功能，可以考虑：

- 支持其他适配器的头像获取
- 添加人设版本管理（同一用户多次克隆）
- 支持多人混合人设生成
- 添加情感倾向分析
- 支持语音消息的语气分析
